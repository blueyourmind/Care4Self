<!DOCTYPE html>
<html lang="en" turbo-action="replace">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Care4self</title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Function to display notifications
  function displayNotifications(notifications) {
    const notificationsContainer = document.getElementById('notificationsContainer');

    if (!notificationsContainer) {
      console.error('Notifications container not found!');
      return;
    }

    // Clear existing notifications
    notificationsContainer.innerHTML = '';

    // Iterate through notifications and append to the container
    notifications.forEach(notification => {
      const notificationCard = createNotificationCard(notification);
      notificationsContainer.appendChild(notificationCard);
    });
  }

  // Function to create a notification card
  function createNotificationCard(notification) {
    const card = document.createElement('div');
    card.classList.add('notification-card');

    const message = document.createElement('p');
    message.textContent = notification.message;
    card.appendChild(message);

    const closeButton = document.createElement('button');
    closeButton.textContent = 'Close';
    closeButton.addEventListener('click', () => {
      card.remove();
    });
    card.appendChild(closeButton);

    return card;
  }

  // Function to calculate the time difference and fetch notifications accordingly
  function calculateTimeDifference(medicationStartTime) {
    const currentTime = new Date();
    const timeDifference = medicationStartTime - currentTime;

    console.log('Time difference:', timeDifference);

    // Set a timeout to fetch notifications when the time difference becomes zero
    setTimeout(() => fetchNotifications(), timeDifference);
  }

  // Function to fetch notifications
  function fetchNotifications() {
    console.log('Fetching notifications...');
    fetch('/notifications')
      .then(response => response.json())
      .then(data => {
        console.log('Fetched notifications:', data);
        displayNotifications(data);
      })
      .catch(error => console.error('Error fetching notifications:', error));
  }

  // Assuming medicationStartTimes is an array of start times sent from your Rails view
  const medicationStartTimes = [
    <% @medications.each do |medication| %>
      new Date('<%= medication.start_time %>'),
    <% end %>
  ];

  // Calculate time differences for each medication
  medicationStartTimes.forEach(medicationStartTime => {
    calculateTimeDifference(medicationStartTime);
  });
});
</script>


    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <%= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css", "data-turbo-track": "reload" %>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@500&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@200&display=swap" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Hammersmith+One&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <script src="https://cdn.jsdelivr.net/npm/actioncable"></script>
    <script>
      const cable = ActionCable.createConsumer("ws://localhost:3000/cable");
    </script>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Teko:wght@300&display=swap" rel="stylesheet">
    <%= javascript_include_tag "https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js", "data-turbo-track": "reload"%>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
  </head>

  <body>

    <%= render "shared/flashes" %>
    <%= render "shared/navbar" %>
    <%= yield %>
    <%= render "shared/footer"%>
  <div id="notificationsContainer"></div>

  </body>
</html>
